name: Reusable Gemini Reviewer

on:
  workflow_call:
    secrets:
      GEMINI_API_KEY:
        required: true

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Gemini Libs
        run: npm install @google/generative-ai @octokit/rest

      - name: Run Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          BASE_BRANCH: ${{ github.base_ref }}
        run: |
          cat << 'EOF' > reviewer.js
          const { GoogleGenerativeAI } = require("@google/generative-ai");
          const { Octokit } = require("@octokit/rest");
          const { execSync } = require("child_process");

          // ðŸ‘‡ RETRY LOGIC FUNCTION
          async function generateWithRetry(model, prompt, retries = 3) {
            for (let i = 0; i < retries; i++) {
              try {
                return await model.generateContent(prompt);
              } catch (error) {
                // Check for Rate Limit (429)
                if (error.response && error.response.promptFeedback) {
                   console.log("Blocked by safety filters.");
                   throw error;
                }
                
                // If 429 (Too Many Requests)
                if (error.status === 429 || error.message.includes('429')) {
                  console.warn(`âš ï¸ Quota hit. Waiting 60 seconds... (Attempt ${i + 1}/${retries})`);
                  await new Promise(resolve => setTimeout(resolve, 60000));
                } else {
                  throw error; // If it's another error, crash immediately
                }
              }
            }
            throw new Error("Max retries exceeded. API is too busy.");
          }

          async function run() {
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
            
            // ðŸ‘‡ SWITCHED TO STABLE MODEL
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

            // 1. Get the Diff
            const baseBranch = process.env.BASE_BRANCH || 'main';
            console.log(`Diffing against origin/${baseBranch}...`);
            try {
                execSync(`git fetch origin ${baseBranch} --depth=1`);
            } catch (e) {
                console.warn("Fetch failed, assuming history is present.");
            }

            const diff = execSync(`git diff origin/${baseBranch}...HEAD`).toString();

            if (!diff || diff.length < 5) return console.log("No changes detected.");

            // 2. Ask Gemini
            const prompt = `
              You are a Senior Code Reviewer. Review the following git diff.
              Identify critical bugs, security issues, and bad practices.
              Output purely a JSON array of objects. No markdown formatting.
              Format: [{"path": "filename", "line": line_number, "body": "comment"}]
              If no issues, output [].
              
              DIFF:
              ${diff.substring(0, 30000)} 
            `;
            
            // Call via the retry wrapper
            const result = await generateWithRetry(model, prompt);
            const response = result.response.text().replace(/```json|```/g, "").trim();
            
            let comments;
            try {
                comments = JSON.parse(response);
            } catch (e) {
                console.error("JSON Parse Error. Raw response:", response);
                comments = [];
            }

            // 3. Post Comments
            if (comments.length === 0) {
              await octokit.issues.createComment({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                issue_number: Number(process.env.PR_NUMBER),
                body: "LGTM! ðŸš€ No issues found."
              });
            } else {
               const jsonStr = JSON.stringify(comments, null, 2);
               const commentBody = "Gemini found " + comments.length + " issues.\n\n" +
                                   "<details>\n" +
                                   "<summary>Click to see raw JSON for CLI</summary>\n\n" +
                                   "```json\n" + jsonStr + "\n```\n" +
                                   "</details>";

               await octokit.issues.createComment({
                owner: process.env.REPO_OWNER,
                repo: process.env.REPO_NAME,
                issue_number: Number(process.env.PR_NUMBER),
                body: commentBody
              });
              console.log("Review posted.");
            }
          }
          run().catch(e => { console.error(e); process.exit(1); });
          EOF
          
          node reviewer.js
